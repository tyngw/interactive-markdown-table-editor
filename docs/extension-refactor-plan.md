## 概要

このドキュメントは `src/extension.ts` のリファクタリング方針をまとめたもの。目的は責務分離、テスト容易性、可読性・保守性の向上です。

## まず評価すべき点（判断基準）
- ファイル行数と複雑度（関数・クロージャの深さ、ネスト）
- 複数の責務（例: コマンド登録、設定読み込み、長い初期化処理、ビジネスロジック）
- 単体テスト化が困難なロジックの存在
- サイドエフェクト（グローバル状態・同期的ファイルI/O等）が多いか

上記のいずれかが該当する場合、分割・抽出の価値は高いです。該当しない場合は軽微な整理に留めます。

## 目標
- `extension.ts` はエントリ（activation / deactivate）に限定する。
- 実装の詳細は責務ごとのモジュール（例: `WebviewManager`, `FileHandler`, `GitDiffUtils`）へ移す。
- 各移行ユニットはユニットテストで検証可能にする。

## スコープ（何をするか／しないか）
- する: コマンド登録の委譲、初期化ロジックの抽出、エラーハンドリングとロギングの一貫化、テスト追加
- しない: 大規模なアーキテクチャ変更や UI ロジックの全面的書き換え（Webview の UI は別作業）

## 実施手順（段階的）
1. 現状評価（影響範囲の特定）
   - `src/extension.ts` を読み、責務を箇条書きにする。
   - 参照しているモジュール一覧を列挙する。
2. 抽出設計
   - 役割ごとに候補モジュールを定義する（例: `ActivationManager`, `CommandRegistry`, `TelemetryManager`）
   - 公開 API（コンストラクタ / 初期化メソッド / dispose）を決める。
3. 小さなリファクタ単位で移行（1コミット = 1責務）
   - 例: まずコマンド登録を `CommandRegistry` に移す。
   - そのコミットごとに `npm run compile` とテストを実行。
4. テストとビルド
   - 新しいモジュールに対するユニットテストを追加。
   - 統合テスト（既存の `npm test`）を通す。
5. PR とレビュー
   - 小さい差分で段階的にレビューを受ける。

## テスト戦略
- ユニットテスト: 新規モジュールごとにテストを作成（`test/unit` へ）
- 統合テスト: `npm run compile` 後に `npm test` を必ず通す
- Webview 関連の E2E は必要に応じて `test/integration` で追加

## 受入基準（完了条件）
- `extension.ts` が「activation と deactivate のみ」を担う構造になっていること
- すべての既存テストがパスすること
- 新規追加モジュールに対するユニットテストが十分であること

## リスクと緩和策
- リスク: 大きな差分によりレビューが遅延する。
  緩和: 小さなコミット単位で段階的に実施する。
- リスク: ビルドやテストが壊れる。
  緩和: 各ステップで `npm run compile` と単体テストを必ず実行。

## 開発フロー上の注意（パッケージ化ルール）
- 挙動に変更を加えた場合は `npm run compile` → `npm run test` を実行し、全テストをパスさせること（詳細はプロジェクト内のルールに従う）。
- 変更がある場合は `CHANGELOG.md` と `package.json` の `version` の更新規則に従うこと（バージョン更新ルールはリポジトリ内ルールに従う）。

## 実装タスクリスト（短期）
- `extension.ts` の責務を列挙してドキュメント化
- 最優先で抽出すべきモジュールを 1–3 個決定
- 1つ目の抽出を実装してテストを追加
- ビルド・テストを通して PR を作成

## 推奨ファイル例（命名例）
- `src/activation/ActivationManager.ts`
- `src/commands/CommandRegistry.ts`
- `src/managers/WebviewManager.ts`（既存の `webviewManager.ts` があれば調整）

## 次のアクション（提案）
1. 今すぐ `src/extension.ts` をレビューして責務の短い箇条書きを作成（作業時間: 30–60分）
2. 最初の抽出対象（例: コマンド登録）を決めて小さい PR を作成

---
作成者: 自動生成（要レビュー）
更新日: 2026-01-29
